name: Build and push images
on:
  # push:
  #   branches:
  #     - master
  pull_request:
    branches: [ 'master' ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup Bazel
      uses: abhinavsingh/setup-bazel@v3
      with:
        version: 3.4.1

    - name: Install python3
      uses: actions/setup-python@v2
      with:
        python-version: '3.9.1' # Version range or exact version of a Python version to use, using SemVer's version range syntax
        architecture: 'x64' # optional x64 or x86. Defaults to x64 if not specified

    - name: Build dpkg_parser
      run: bazel build //package_manager:dpkg_parser.par

    - name: Build Erlang images
      run: |
        bazel run experimental/erlang:erlang_root_amd64_debian10
        bazel run experimental/erlang:debug_root_amd64_debian10

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

    - name: Push Erlang images
      run: |
        bazel run experimental/erlang:push_erlang_root_amd64_debian10
        bazel run experimental/erlang:push_debug_root_amd64_debian10
